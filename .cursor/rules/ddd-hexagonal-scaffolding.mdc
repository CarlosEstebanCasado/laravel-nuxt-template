---
alwaysApply: true
---

# DDD/Hexagonal Scaffolding Rules (Laravel)
These rules define the **mandatory scaffolding** for adding a new **BoundedContext** or a new **module/aggregate** inside an existing BoundedContext in this repository.

## Naming + namespaces
- **Root namespace**: `App\\Src\\{Context}\\{Module}\\...`
- **Context**: PascalCase (e.g. `Auth`, `Billing`, `Catalog`, `Security`)
- **Module** (aggregate root folder): PascalCase (e.g. `User`, `Session`, `Audit`, `Payment`)
- **Layers**: `Domain`, `Application`, `Infrastructure`, `UI`
- **No cross-layer mixing**:
  - `Domain` and `Application` must not import `Illuminate\\*`, Facades, Eloquent models (`App\\Models\\*`), Socialite, etc.
  - Framework glue (Laravel container bindings, controllers, middleware, requests, resources/responses) lives in `UI` or in Laravel `app/Providers`.
  - Persistence/adapters (Eloquent/DB/etc.) live in `Infrastructure`.

## Scaffolding: new BoundedContext
When creating a **new BoundedContext**, create the context folder and at least one module folder. Example (replace names):

```
backend/app/src/{Context}/
  {Module}/
    Domain/
      Entity/
      ValueObject/
      Service/
      Repository/
      Exception/
    Application/
      UseCase/
      Request/
      Response/
      Converter/
    Infrastructure/
      Eloquent/
        Model/
        Repository/
      Mapper/
      Provider/
    UI/
      Controllers/
        Api/
      Request/
      Middleware/
      Routes/
```

### Notes
- **`Exception/`** is where domain exceptions live (e.g. invariants).
- **`Application/Response/`** is for DTOs returned by UseCases (optional, but scaffold it).
- **`Infrastructure/Eloquent/Model/`** is for persistence models if you decide to move Eloquent models out of `App\\Models`.
  - If you keep Eloquent models in `App\\Models`, `Infrastructure/Eloquent/Model/` may remain empty.
- **`Infrastructure/Provider/`** is only for infrastructure composition/bindings local to the module (optional). Prefer bindings in Laravel `backend/app/Providers/*`.
- **`UI/Fortify/`** solo aplica a contextos relacionados con autenticación; omítelo en módulos que no extiendan Fortify.
- **`UI/Routes/`** is for route group files if you choose to modularize route definitions. If not used, keep empty or omit.
- **Strict typing**: Every `.php` file under `/src` must declare `declare(strict_types=1);` immediately after the opening `<?php` tag.

## Scaffolding: new module (aggregate) inside an existing context
For each new `{Module}` (aggregate root folder), create **all** of the following directories (even if initially empty):

```
backend/app/src/{Context}/{Module}/
  Domain/
    Entity/
    ValueObject/
    Service/
    Repository/
    Exception/
  Application/
    UseCase/
    Request/
    Response/
    Converter/
  Infrastructure/
    Eloquent/
      Model/
      Repository/
    Mapper/
    Provider/
  UI/
    Controllers/
      Api/
    Request/
    Middleware/
    Routes/
```

## Mandatory placement rules
- **Controllers**: `.../UI/Controllers/**`
- **Controller FormRequests** (HTTP validation): `.../UI/Request/**`
- **UseCases**: `.../Application/UseCase/**`
- **UseCase input DTOs**: `.../Application/Request/**` (suffix: `*UseCaseRequest`)
- **UseCase output DTOs** (when needed): `.../Application/Response/**` (suffix: `*Result` or `*Response`)
- **Domain entities**: `.../Domain/Entity/**`
- **Domain services**: `.../Domain/Service/**`
- **Domain value objects**: `.../Domain/ValueObject/**`
- **Domain repository ports** (interfaces): `.../Domain/Repository/**`
- **Infrastructure repository adapters**:
  - Eloquent adapter: `.../Infrastructure/Eloquent/Repository/Eloquent{Entity}Repository.php`
  - Non-Eloquent adapter: `.../Infrastructure/{AdapterName}{Entity}Repository.php` (if needed)
- **Mappers** (Domain ↔ Persistence/DTO): `.../Infrastructure/Mapper/**`
- **Migrations**: cuando añadas columnas nuevas en cualquier tabla debes declararlas justo antes de `created_at`/`updated_at` en la migración. Así, al inspeccionar la tabla en la base de datos, los campos de tracking permanecen al final y las nuevas columnas quedan agrupadas con el resto de datos del dominio.
- **Controllers**: son single-action. Cada controlador debe tener un único método público `__invoke()` y estar asociado a un solo endpoint. Nunca reutilizar un controlador para varios endpoints ni añadir métodos públicos extra.
- **Dependency injection**: los nombres de las variables inyectadas deben coincidir exactamente con el nombre del fichero/clase (sin abreviar ni renombrar) para evitar ambigüedad.
- **Entities**: todas las propiedades de las entidades deben ser Value Objects propios del dominio. No se permiten tipos primitivos (string/int/bool/array) como propiedades de entidades.
- **Domain services**: cualquier acción que modifique parámetros de una entidad debe implementarse en un servicio de dominio. Evita mutaciones directas en entidades desde Application/Infrastructure/UI para poder reutilizar la lógica sin romper la arquitectura hexagonal.
- **Eloquent models**: todos los modelos Eloquent deben estar auditados para registrar cualquier modificación.

## Localization + User Preferences
- **Config access**: dentro de `/src` está prohibido usar `config()` directamente. Usa siempre el puerto `Shared/Domain/Service/ConfigProvider` y su implementación `Shared/Infrastructure/LaravelConfigProvider`. Esto evita acoplar Domain/Application a Laravel y permite tests puros con mocks.
- **Locales soportados** se declaran en `config/app.php` (`supported_locales`) y cualquier servicio que los necesite deberá leerlos desde configuración (nunca hardcodearlos). Cuando el contenedor no está bootstrapped (tests unitarios puros) debemos proveer un fallback seguro en el propio servicio.
- El switch de idioma se resuelve a través del middleware `Shared/UI/Middleware/SetLocaleFromRequest`, que consulta cabecera `X-Locale`, preferencia del usuario (`UserPreferencesRepository`) y por último `Request::getPreferredLanguage`. Cualquier endpoint expuesto debe incluir el alias `locale` para garantizar que la request se procesa en el idioma correcto.
- Las preferencias del usuario (idioma, tema, etc.) se tratan como un módulo de Auth/User:
  - Entidad: `IdentityAccess/Auth/User/Domain/Entity/UserPreferences`.
  - Puerto: `Domain/Repository/UserPreferencesRepository`.
  - Adaptador Eloquent + modelo dedicado en `Infrastructure/Eloquent`.
  - UseCases `GetUserPreferencesUseCase` y `UpdateUserPreferencesUseCase` con sus DTOs correspondientes.
  - Controlador API en `UI/Controllers/Api/UserPreferencesController`.
- Cualquier nueva preferencia persistible debe añadirse a la entidad, al repositorio y a los DTOs sin romper la convención anterior. Los controladores deben validar contra `config('app.supported_locales')` y `config('preferences.themes')` (u otras configuraciones específicas), nunca contra literales.

### Repository responses + converters
- Infra repositories nunca devuelven arrays “raw”. Construyen entidades/colecciones de dominio (p.ej. `AuditCollectionResponse`) usando utilidades compartidas (`App\\Src\\Shared\\Domain\\Collection`, `PaginationResponse`, etc.).
- Cada módulo debe incluir `Application/Converter/` con converters responsables de transformar las colecciones tipadas en DTOs públicos (`Application/Response/**`). Divide los converters en “list” + “item” cuando proceda para fomentar reutilización.
- Los UseCases consumen el repositorio, invocan al converter adecuado (`->toResponse(...)`) y devuelven el DTO final.
- Los controladores solo serializan el DTO retornado por el UseCase; no deben mapear arrays ni acceder a modelos directamente.

## DTO conventions (Application/Request)
- `*UseCaseRequest` MUST be a **simple immutable DTO**:
  - `final class`
  - `public function __construct(public readonly ...$props) {}`
  - **No getters**
  - **No magic accessors** (`__get`, `__set`)
- Exception: if construction requires invariants/normalization, use:
  - `private function __construct(...)`
  - `public static function fromPrimitives(...)` / `create(...)`
  - (getters allowed only when needed by that pattern)

## Dependency direction (Hexagonal)
- `UI` → `Application` → `Domain`
- `Infrastructure` implements `Domain` ports (e.g. repositories) and is wired via container bindings.
- `Domain` must not reference `Infrastructure` or `UI`.
- `Application` must not reference `Infrastructure` or `UI` types (except its own DTOs).

## Minimal “first files” checklist (recommended)
When scaffolding a new module, prefer creating these first:
- `Domain/Repository/{Aggregate}Repository.php` (port)
- `Application/UseCase/{Verb}{Aggregate}UseCase.php`
- `Application/Request/{Verb}{Aggregate}UseCaseRequest.php`
- `Infrastructure/Eloquent/Repository/Eloquent{Aggregate}Repository.php` (adapter, if using Eloquent)
- `UI/Controllers/Api/{Verb}{Aggregate}Controller.php`
- `UI/Request/{Verb}{Aggregate}Request.php` (if needed)
